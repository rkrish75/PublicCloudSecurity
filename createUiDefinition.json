{
 "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
 "handler": "Microsoft.Compute.MultiVm",
 "version": "0.1.2-preview",
 "parameters": {
    "basics": [
      {
        "name": "Name",
        "type": "Microsoft.Common.TextBox",
        "label": "Virtual Machine name",
        "toolTip": "The name of the Virtual Machine.",
        "constraints": {
          "required": true,
          "regex": "^[a-z0-9A-Z-]{3,24}$",
          "validationMessage": "The VM Name must be between 3 and 24 characters long and contain letters, numbers and hyphens only."
        }
      },
      {
        "name": "billingType",
        "type": "Microsoft.Common.DropDown",
        "label": "Licensing",
        "defaultValue": "BYOL : Bring-your-own-license",
        "toolTip": "Select licensing model",
        "constraints": {
          "allowedValues": [
            {
              "label": "BYOL : Bring-your-own-license",
              "value": "ftdv-azure-byol"
            },
            {
              "label": "PAYG : Pay-as-you-go",
              "value": "ftdv-azure-payg"
            }
          ]
        },
        "visible": true
      },
      {
        "name": "softwareVersionByol",
        "type": "Microsoft.Common.DropDown",
        "label": "Software Version",
        "defaultValue": "6.7.0-65",
        "toolTip": "Select a version of software to deploy",
        "constraints": {
          "allowedValues": [
            {
              "label": "6.7.0-65",
              "value": "67065.0.0"
            },
            {
              "label": "6.6.1-91",
              "value": "66191.0.0"
            },
            {
              "label": "6.4.0-110",
              "value": "640110.0.0"
            }
          ]
        },
        "visible": "[equals('ftdv-azure-byol', basics('billingType'))]"
      },
      {
        "name": "softwareVersionPayg",
        "type": "Microsoft.Common.DropDown",
        "label": "Software Version",
        "defaultValue": "6.7.0-65",
        "toolTip": "Select a version of software to deploy",
        "constraints": {
          "allowedValues": [
            {
              "label": "6.7.0-65",
              "value": "67065.0.0"
            },
            {
              "label": "6.6.1-91",
              "value": "66191.0.0"
            }
          ]
        },
        "visible": "[equals('ftdv-azure-payg', basics('billingType'))]"
      },
      {
        "name": "availabilityOption",
        "type": "Microsoft.Common.OptionsGroup",
        "label": "Availability Option",
        "defaultValue": "None",
        "toolTip": "You can optionally specify an availability zone in which to deploy your VM. If you choose to do so, your public IP and virtual machine will be created in specified availability zone. Public IP will use the Standard SKU and Dynamic allocation to support this.",
        "constraints": {
          "allowedValues": [
            {
              "label": "None",
              "value": "none"
            },
            {
              "label": "Availability Zone",
              "value": "availabilityZone"
            }
          ],
          "required": true
        },
        "visible": true
      },
      {
        "name": "availabilityZone",
        "type": "Microsoft.Common.TextBox",
        "label": "Availability Zone",
        "defaultValue": "1",
        "toolTip": "Specify the availability zone for deployment. Ensure that selected region supports availability zones and value provided is correct.",
        "constraints": {
          "required": true,
          "regex": "^[1-3]$",
          "validationMessage": "Allowed values for availability zone is 1, 2 or 3."
        },
        "visible": "[equals('availabilityZone', basics('availabilityOption'))]"
      },
      {
        "name": "adminUsername",
        "type": "Microsoft.Compute.UserNameTextBox",
        "label": "Username for primary account (not the FTDv admin user account)",
        "toolTip": "Username for primary account on the virtual machine (used only for vm management). This is not the admin username and 'admin' is reserved.",
        "osPlatform": "Linux"
      },
      {
          "name": "SSHCredentials",
          "type": "Microsoft.Compute.CredentialsCombo",
          "label": {
              "authenticationType": "Authentication type",
              "password": "Password",
              "confirmPassword": "Confirm password",
              "sshPublicKey": "SSH public key"
          },
          "toolTip": {
              "authenticationType": "Authentication Type for the Linux Virtual Machine",
              "password": "Password for the Virtual Machine",
              "sshPublicKey": "SSH Public Key for the Virtual Machine"
          },
          "constraints": {
              "required": true,
              "customPasswordRegex": "^(?=.{12,72})(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[\\x21-\\x2F\\x3A-\\x40\\x5B-\\x60\\x7B-\\x7E])(?!.*(.)\\1{2,})[\\x20-\\x7E]*$",
              "customValidationMessage": "Passwords must be 12 to 72 characters long, must have : lowercase, uppercase, numbers & special characters and must have no more than 2 repeating characters."
          },
          "options": {
              "hideConfirmation": false
          },
          "osPlatform": "Linux"
      },
      {
        "name": "FTDAdminPassword",
        "type": "Microsoft.Common.PasswordBox",
        "label": {
          "password": "Admin Password",
          "confirmPassword": "Confirm Admin Password"
        },
        "toolTip": "Enter the password for 'admin' user on FTDv",
        "constraints": {
          "required": true,
          "regex": "^(?=.{12,72})(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[\\x21-\\x2F\\x3A-\\x40\\x5B-\\x60\\x7B-\\x7E])(?!.*(.)\\1{2,})[\\x20-\\x7E]*$",
          "validationMessage": "Passwords must be 12 to 72 characters long, must have : lowercase, uppercase, numbers & special characters and must have no more than 2 repeating characters."
        },
        "options": {
          "hideConfirmation": false
        },
        "visible": true
      },
      {
        "name": "manageLocally",
        "type": "Microsoft.Common.DropDown",
        "label": "FTDv Management",
        "defaultValue": "FDM : Firepower Device Management",
        "toolTip": "Select the option to manage FTDv",
        "constraints": {
          "allowedValues": [
            {
              "label": "FDM : Firepower Device Management",
              "value": "Yes"
            },
            {
              "label": "FMC : Firepower Management Center",
              "value": "No"
            }
          ],
          "required": true
        },
        "visible": "[and(equals('ftdv-azure-byol', basics('billingType')), not(contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0,2))))]"
      },
      {
        "name": "fmcDetails",
        "type": "Microsoft.Common.OptionsGroup",
        "label": "Enter FMC registration information",
        "defaultValue": "No",
        "toolTip": "Enter the fields required for registration with FMC",
        "constraints": {
          "allowedValues": [
            {
              "label": "Yes",
              "value": "Yes"
            },
            {
              "label": "No",
              "value": "No"
            }
          ],
          "required": true
        },
        "visible": "[not(and(equals('Yes', basics('manageLocally')), equals('ftdv-azure-byol', basics('billingType')), not(contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0,2)))))]"
      },
      {
        "name": "FmcIp",
        "type": "Microsoft.Common.TextBox",
        "label": "FMC IP",
        "defaultValue": "",
        "toolTip": "Enter the FMC IP/Hostname/DONTRESOLVE",
        "constraints": {
          "required": true,
          "regex": "^(?:(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])(\\.(?!$)|$)){4}$|(?=^.{4,253}$)(^((?!-)[a-zA-Z0-9-]{0,62}[a-zA-Z0-9]\\.)+[a-zA-Z]{2,63})$|^DONTRESOLVE$",
          "validationMessage": "Only FMC IP, Hostname or 'DONTRESOLVE' are allowed in FMC IP field."
        },
        "visible": "[and(not(and(equals('Yes', basics('manageLocally')), equals('ftdv-azure-byol', basics('billingType')), not(contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0,2))))),equals('Yes', basics('fmcDetails')))]"
      },
      {
        "name": "FmcRegKey",
        "type": "Microsoft.Common.TextBox",
        "label": "FMC registration key",
        "defaultValue": "",
        "toolTip": "Enter the key to be used for registration",
        "constraints": {
          "required": true,
          "regex": "^[a-z0-9A-Z]{3,}$",
          "validationMessage": "Registration key must contain 3 or more alphanumeric characters."
        },
        "visible": "[and(not(and(equals('Yes', basics('manageLocally')), equals('ftdv-azure-byol', basics('billingType')), not(contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0,2))))),equals('Yes', basics('fmcDetails')))]"
      },
      {
        "name": "FmcNatId",
        "type": "Microsoft.Common.TextBox",
        "label": "FMC NAT ID",
        "defaultValue": "",
        "toolTip": "Enter the NAT ID to be used during registration (optional)",
        "constraints": {
          "regex": "^[a-z0-9A-Z]{3,}$",
          "validationMessage": "NAT ID must contain 3 or more alphanumeric characters."
        },
        "visible":"[and(not(and(equals('Yes', basics('manageLocally')), equals('ftdv-azure-byol', basics('billingType')), not(contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0,2))))),equals('Yes', basics('fmcDetails')))]"
      }
    ],
    "steps": [
      {
        "name": "ciscoFTDvConfig",
        "label": "Cisco FTDv settings",
        "subLabel": {
          "preValidation": "Configure the FTDv settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Cisco FTDv settings",
        "elements": [
          {
            "name": "LargerSize",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "Virtual machine size",
            "toolTip": "The size of virtual machine to provision.",
            "recommendedSizes": [
              "Standard_D3_v2",
              "Standard_D4_v2",
              "Standard_D5_v2"
            ],
            "constraints": {
              "allowedSizes": [
                "Standard_D3",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D5_v2"
              ]
            },
            "osPlatform": "Linux",
            "imageReference": {
              "publisher": "cisco",
              "offer": "cisco-ftdv",
              "sku": "[basics('billingType')]"
            },
            "count": "1",
            "visible": "[or( and(equals('ftdv-azure-byol', basics('billingType')), not(contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0, 2))) ), equals('ftdv-azure-payg', basics('billingType')))]"
          },
          {
            "name": "Size",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "Virtual machine size",
            "toolTip": "The size of virtual machine to provision.",
            "recommendedSizes": [
              "Standard_D3_v2"
            ],
            "constraints": {
              "allowedSizes": [
                "Standard_D3",
                "Standard_D3_v2"
              ]
            },
            "osPlatform": "Linux",
            "imageReference": {
              "publisher": "cisco",
              "offer": "cisco-ftdv",
              "sku": "[basics('billingType')]"
            },
            "count": "1",
            "visible": "[and(equals('ftdv-azure-byol', basics('billingType')), contains('62-63-64', substring(coalesce(basics('softwareVersionByol'), 'NONE'), 0, 2)))]"
          },
          {
            "name": "storageAccount",
            "type": "Microsoft.Storage.StorageAccountSelector",
            "label": "Storage account",
            "toolTip": "Storage Account for the Virtual Machine's Disks",
            "defaultValue": {
              "type": "Standard_LRS",
              "name": "[toLower(take(concat(replace(basics('Name'), '-', ''), replace(guid(), '-', '')), 24))]"
            },
            "constraints": {
              "allowedTypes": [
                "Standard_LRS"
              ]
            },
              "options": {
                "hideExisting": true
            }
          },
          {
            "name": "publicIpAddress",
            "type": "Microsoft.Network.PublicIpAddressCombo",
            "label": {
              "publicIpAddress": "Public IP address",
              "domainNameLabel": "DNS label"
            },
            "toolTip": {
              "publicIpAddress": "Public IP address label that will be associated with the management interface",
              "domainNameLabel": "DNS label for the Virtual Machine's public IP address."
            },
            "defaultValue": {
              "publicIpAddressName": "[toLower(concat(basics('Name'), '-ip'))]",
              "domainNameLabel": "[toLower(concat(basics('Name'), '-', take(replace(guid(), '-', ''), 10)))]"
            },
            "constraints": {
              "required": {
                "domainNameLabel": true
              }
            },
            "options": {
              "hideNone": true
            }
          },
          {
            "name": "virtualNetwork",
            "type": "Microsoft.Network.VirtualNetworkCombo",
            "label": {
                "virtualNetwork": "Virtual network",
                "subnets": "Subnets"
            },
            "toolTip": {
                "virtualNetwork": "Virtual Network Name",
                "subnets": "Subnets required for the Cisco FTDv solution"
            },
            "defaultValue": {
                "name": "vnet01",
                "addressPrefixSize": "/16"
            },
            "constraints": {
                "minAddressPrefixSize": "/27"
            },
            "subnets": {
                "subnet1": {
                    "label": "Management subnet",
                    "defaultValue": {
                      "addressPrefixSize": "/24"
                    },
                    "constraints": {
                        "minAddressPrefixSize": "/29",
                        "minAddressCount": 1,
                        "requireContiguousAddresses": false
                    }
                },
                "subnet2": {
                    "label": "Diagnostic subnet",
                    "defaultValue": {
                      "addressPrefixSize": "/24"
                    },
                    "constraints": {
                        "minAddressPrefixSize": "/29",
                        "minAddressCount": 1,
                        "requireContiguousAddresses": false
                    }
                },
                "subnet3": {
                    "label": "GigabitEthernet 0/0 subnet",
                    "defaultValue": {
                      "addressPrefixSize": "/24"
                    },
                    "constraints": {
                        "minAddressPrefixSize": "/29",
                        "minAddressCount": 1,
                        "requireContiguousAddresses": false
                    }
                },
                "subnet4": {
                    "label": "GigabitEthernet 0/1 subnet",
                    "defaultValue": {
                      "addressPrefixSize": "/24"
                    },
                    "constraints": {
                        "minAddressPrefixSize": "/29",
                        "minAddressCount": 1,
                        "requireContiguousAddresses": false
                    }
                }
            }
        }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "vmName": "[basics('Name')]",
      "billingType": "[basics('billingType')]",
      "softwareVersionByol": "[basics('softwareVersionByol')]",
      "softwareVersionPayg": "[basics('softwareVersionPayg')]",
      "availabilityOption": "[basics('availabilityOption')]",
      "availabilityZone": "[int(basics('availabilityZone'))]",
      "ftdAdminPassword": "[basics('FTDAdminPassword')]",
      "manageLocally": "[basics('manageLocally')]",
      "fmcDetails": "[basics('fmcDetails')]",
      "fmcIp": "[basics('FmcIp')]",
      "fmcRegKey": "[basics('FmcRegKey')]",
      "fmcNatId": "[basics('FmcNatId')]",
      "adminUsername": "[basics('adminUsername')]",
      "adminPassword": "[basics('SSHCredentials').password]",
      "sshPublicKey": "[basics('SSHCredentials').sshPublicKey]",
      "authenticationType" : "[basics('SSHCredentials').authenticationType]",
      "vmSize": "[steps('ciscoFTDvConfig').Size]",
      "vmLargerSize": "[steps('ciscoFTDvConfig').LargerSize]",

      "storageAccountName" : "[steps('ciscoFTDvConfig').storageAccount.name]",
      "storageAccountType" : "[steps('ciscoFTDvConfig').storageAccount.type]",
      "storageAccountNewOrExisting" : "[steps('ciscoFTDvConfig').storageAccount.newOrExisting]",
      "storageAccountRG" : "[steps('ciscoFTDvConfig').storageAccount.resourceGroup]",

      "publicIPAddressName" : "[steps('ciscoFTDvConfig').publicIpAddress.name]",
      "publicIPDnsLabel" : "[steps('ciscoFTDvConfig').publicIpAddress.domainNameLabel]",
      "publicIPNewOrExisting" : "[steps('ciscoFTDvConfig').publicIpAddress.newOrExistingOrNone]",
      "publicIPRG" : "[steps('ciscoFTDvConfig').publicIpAddress.resourceGroup]",
      "publicIPAllocationMethod": "[steps('ciscoFTDvConfig').publicIpAddress.publicIPAllocationMethod]",
      "publicIPsku": "[steps('ciscoFTDvConfig').publicIpAddress.sku]",

      "virtualNetworkName" : "[steps('ciscoFTDvConfig').virtualNetwork.name]",
      "virtualNetworkAddressPrefix" : "[steps('ciscoFTDvConfig').virtualNetwork.addressPrefix]",
      "virtualNetworkNewOrExisting" : "[steps('ciscoFTDvConfig').virtualNetwork.newOrExisting]",
      "virtualNetworkRG" : "[steps('ciscoFTDvConfig').virtualNetwork.resourceGroup]",
      "Subnet1Name" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet1.name]",
      "Subnet1Prefix" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet1.addressPrefix]",
      "Subnet2Name" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet2.name]",
      "Subnet2Prefix" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet2.addressPrefix]",
      "Subnet3Name" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet3.name]",
      "Subnet3Prefix" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet3.addressPrefix]",
      "Subnet4Name" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet4.name]",
      "Subnet4Prefix" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet4.addressPrefix]",
      "subnet1StartAddress" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet1.startAddress]",
      "subnet2StartAddress" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet2.startAddress]",
      "subnet3StartAddress" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet3.startAddress]",
      "subnet4StartAddress" : "[steps('ciscoFTDvConfig').virtualNetwork.subnets.subnet4.startAddress]"
    }
  }
}
